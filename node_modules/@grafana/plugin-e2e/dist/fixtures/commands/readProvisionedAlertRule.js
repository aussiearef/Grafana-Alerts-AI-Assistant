'use strict';

var path = require('path');
var yaml = require('yaml');
var fs = require('fs');

const ALERTING_DIR = "alerting";
const readProvisionedAlertRule = async ({ provisioningRootDir }, use) => {
  await use(async ({ fileName, groupName, ruleTitle }) => {
    const resolvedPath = path.resolve(path.join(provisioningRootDir, ALERTING_DIR, fileName));
    const contents = await fs.promises.readFile(resolvedPath, "utf8");
    const yml = yaml.parse(contents);
    let group = yml.groups[0];
    if (groupName) {
      group = yml.groups.find((group2) => group2.name === groupName);
    }
    let rule = group.rules[0];
    if (ruleTitle) {
      rule = group.rules.find((rule2) => rule2.title === ruleTitle);
    }
    return rule;
  });
};

exports.readProvisionedAlertRule = readProvisionedAlertRule;
