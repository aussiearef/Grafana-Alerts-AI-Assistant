'use strict';

var fs = require('fs');
var path = require('path');
var yaml = require('yaml');

const DATASOURCES_DIR = "datasources";
const readProvisionedDataSource = async ({ provisioningRootDir }, use) => {
  await use(async ({ fileName: filePath, name }) => {
    const resolvedPath = path.resolve(path.join(provisioningRootDir, DATASOURCES_DIR, filePath));
    const contents = await fs.promises.readFile(resolvedPath, "utf8");
    const yml = yaml.parse(contents);
    if (!name) {
      return yml.datasources[0];
    }
    return yml.datasources.find((ds) => ds.name === name);
  });
};

exports.readProvisionedDataSource = readProvisionedDataSource;
